otk.version: 1

otk.define:
  filesystem:
    otk.external.otk-gen-partition-table:
      properties:
        create:
          bios_boot_partition: true
          esp_partition: true
          esp_partition_size: "2 GiB"
        type: gpt
        bios: true
        default_size: "10 GB"
      partitions:
        - name: boot
          mountpoint: /boot
          label: boot
          size: "2 GiB"
          type: "xfs"
          # XXX: make default if empty
          fs_mntops: defaults
        - name: root
          mountpoint: /
          label: root
          type: "xfs"
          # XXX: can/should we be able to leave this empy?
          size: "5 GiB"
          # XXX: make default if empty
          fs_mntops: defaults

otk.target.osbuild:
  pipelines:
    - name: build
      runner: org.osbuild.centos9
      stages:
        - type: org.osbuild.rpm
        - type: org.osbuild.selinux
          options:
            file_contexts: etc/selinux/targeted/contexts/files/file_contexts
            labels:
              /usr/bin/cp: system_u:object_r:install_exec_t:s0
    - name: os
      build: name:build
      stages:
        - type: org.osbuild.kernel-cmdline
          options:
            root_fs_uuid: d8bb61b8-81cf-4c85-937b-69439a23dc5e
            kernel_opts: console=tty0 console=ttyS0,115200n8 no_timer_check net.ifnames=0
        - type: org.osbuild.rpm
        - type: org.osbuild.fix-bls
          options:
            prefix: ""
        - type: org.osbuild.locale
          options:
            language: C.UTF-8
        - type: org.osbuild.timezone
          options:
            zone: America/New_York
        - type: org.osbuild.sysconfig
          options:
            kernel:
              update_default: true
              default_kernel: kernel
            network:
              networking: true
              no_zero_conf: true
        - otk.external.otk-make-fstab-stage:
            ${filesystem}
        - type: org.osbuild.grub2
          options:
            root_fs_uuid: d8bb61b8-81cf-4c85-937b-69439a23dc5e
            boot_fs_uuid: 9851898e-0b30-437d-8fad-51ec16c3697f
            kernel_opts: console=tty0 console=ttyS0,115200n8 no_timer_check net.ifnames=0
            legacy: i386-pc
            uefi:
              vendor: centos
              unified: true
            saved_entry: ffffffffffffffffffffffffffffffff-5.14.0-496.el9.x86_64
            write_cmdline: false
            config:
              default: saved
        - type: org.osbuild.systemd
          options:
            default_target: multi-user.target
        - type: org.osbuild.selinux
          options:
            file_contexts: etc/selinux/targeted/contexts/files/file_contexts
    - name: image
      build: name:build
      stages:
        - type: org.osbuild.truncate
          options:
            filename: disk.img
            size: "10737418240"
        - type: org.osbuild.sfdisk
          options:
            label: gpt
            uuid: D209C89E-EA5E-4FBD-B161-B461CCE297E0
            partitions:
              - bootable: true
                size: 2048
                start: 2048
                type: 21686148-6449-6E6F-744E-656564454649
                uuid: FAC7F1FB-3E8D-4137-A512-961DE09A5549
              - size: 409600
                start: 4096
                type: C12A7328-F81F-11D2-BA4B-00A0C93EC93B
                uuid: 68B2905B-DF3E-4FB3-80FA-49D1E773AA33
              - size: 2097152
                start: 413696
                type: BC13C2FF-59E6-4262-A352-B275FD6F7172
                uuid: CB07C243-BC44-4717-853E-28852021225B
              - size: 18460639
                start: 2510848
                type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
                uuid: 6264D520-3FB9-423F-8AB8-7A0A8E3D3562
          devices:
            device:
              type: org.osbuild.loopback
              options:
                filename: disk.img
                lock: true
        - type: org.osbuild.mkfs.fat
          options:
            volid: 7B7795E7
          devices:
            device:
              type: org.osbuild.loopback
              options:
                filename: disk.img
                start: 4096
                size: 409600
                lock: true
        - type: org.osbuild.mkfs.xfs
          options:
            uuid: 9851898e-0b30-437d-8fad-51ec16c3697f
            label: boot
          devices:
            device:
              type: org.osbuild.loopback
              options:
                filename: disk.img
                start: 413696
                size: 2097152
                lock: true
        - type: org.osbuild.mkfs.xfs
          options:
            uuid: d8bb61b8-81cf-4c85-937b-69439a23dc5e
            label: root
          devices:
            device:
              type: org.osbuild.loopback
              options:
                filename: disk.img
                start: 2510848
                size: 18460639
                lock: true
        - type: org.osbuild.copy
          inputs:
            root-tree:
              type: org.osbuild.tree
              origin: org.osbuild.pipeline
              references:
                - name:os
          options:
            paths:
              - from: input://root-tree/
                to: mount://-/
          devices:
            '-':
              type: org.osbuild.loopback
              options:
                filename: disk.img
                start: 2510848
                size: 18460639
            boot:
              type: org.osbuild.loopback
              options:
                filename: disk.img
                start: 413696
                size: 2097152
            boot-efi:
              type: org.osbuild.loopback
              options:
                filename: disk.img
                start: 4096
                size: 409600
          mounts:
            - name: '-'
              type: org.osbuild.xfs
              source: '-'
              target: /
            - name: boot
              type: org.osbuild.xfs
              source: boot
              target: /boot
            - name: boot-efi
              type: org.osbuild.fat
              source: boot-efi
              target: /boot/efi
        - type: org.osbuild.grub2.inst
          options:
            filename: disk.img
            platform: i386-pc
            location: 2048
            core:
              type: mkimage
              partlabel: gpt
              filesystem: xfs
            prefix:
              type: partition
              partlabel: gpt
              number: 2
              path: /grub2
    - name: qcow2
      build: name:build
      stages:
        - type: org.osbuild.qemu
          inputs:
            image:
              type: org.osbuild.files
              origin: org.osbuild.pipeline
              references:
                name:image:
                  file: disk.img
          options:
            filename: disk.qcow2
            format:
              type: qcow2
              compat: "1.1"
  sources:
    org.osbuild.curl:
