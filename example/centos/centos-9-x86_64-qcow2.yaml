otk.version: "1"

otk.define:
  # XXX: dedup
  distro: centos
  version: 9
  kernel_commandline: "console=tty0 console=ttyS0,115200n8 no_timer_check net.ifnames=0"
  filesystem:
    modifications:
      # empty
otk.include: "common/gen-partition-table-x86_64.yaml"

otk.target.osbuild:
  pipelines:
    - otk.include: "pipeline/build.yaml"
    - name: os
      build: name:build
      stages:
        - otk.include: "fragment/kernel-cmdline.yaml"
        - type: org.osbuild.rpm
        - type: org.osbuild.fix-bls
          options:
            prefix: ""
        - type: org.osbuild.locale
          options:
            language: C.UTF-8
        - type: org.osbuild.timezone
          options:
            zone: America/New_York
        - type: org.osbuild.sysconfig
          options:
            kernel:
              update_default: true
              default_kernel: kernel
            network:
              networking: true
              no_zero_conf: true
        - otk.external.otk-make-fstab-stage:
            ${filesystem}
        - otk.include: "fragment/grub2.yaml"
        - type: org.osbuild.systemd
          options:
            default_target: multi-user.target
        - type: org.osbuild.selinux
          options:
            file_contexts: etc/selinux/targeted/contexts/files/file_contexts
    - otk.include: "pipeline/image.yaml"
    - name: qcow2
      build: name:build
      stages:
        - type: org.osbuild.qemu
          inputs:
            image:
              type: org.osbuild.files
              origin: org.osbuild.pipeline
              references:
                name:image:
                  file: ${filesystem.const.filename}
          options:
            # XXX: provide a way to derive the name from the filesystem one?
            filename: disk.qcow2
            format:
              type: qcow2
              compat: "1.1"
  sources:
    org.osbuild.curl:
