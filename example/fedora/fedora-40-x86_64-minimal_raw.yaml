otk.version: "1"

otk.define:
  distro: fedora
  version: 40
  kernel_commandline: "ro"
  filesystem:
    modifications:
      # empty
      
otk.include: "common/gen-partition-table-x86_64.yaml"
  
otk.target.osbuild:
  pipelines:
    - otk.include: "../centos/pipeline/build.yaml"
    - name: os
      build: name:build
      stages:
        - otk.include: "../centos/fragment/kernel-cmdline.yaml"
        - type: org.osbuild.rpm
        - type: org.osbuild.fix-bls
          options:
            prefix: ""
        - type: org.osbuild.locale
          options:
            language: en_US
        - type: org.osbuild.hostname
          options:
            hostname: localhost.localdomain
        - type: org.osbuild.timezone
          options:
            zone: UTC
        - otk.external.otk-make-fstab-stage:
            ${filesystem}
        - type: org.osbuild.grub2
          options:
            root_fs_uuid: 9851898e-0b30-437d-8fad-51ec16c3697f
            boot_fs_uuid: dbd21911-1c4e-4107-8a9f-14fe6e751358
            kernel_opts: ro
            uefi:
              vendor: fedora
              unified: true
            saved_entry: ffffffffffffffffffffffffffffffff-6.10.6-200.fc40.x86_64
            write_cmdline: false
            config:
              default: saved
              timeout: 5
        - type: org.osbuild.copy
          inputs:
            file-5ef477a297674dc16b6d212f37875f579a51370d9794a36e57cf0ad91562774e:
              type: org.osbuild.files
              origin: org.osbuild.source
              references:
                - id: sha256:5ef477a297674dc16b6d212f37875f579a51370d9794a36e57cf0ad91562774e
          options:
            paths:
              - from: input://file-5ef477a297674dc16b6d212f37875f579a51370d9794a36e57cf0ad91562774e/sha256:5ef477a297674dc16b6d212f37875f579a51370d9794a36e57cf0ad91562774e
                to: tree:///root/anaconda-ks.cfg
                remove_destination: true
        - type: org.osbuild.chown
          options:
            items:
              /root/anaconda-ks.cfg:
                user: root
                group: root
        - type: org.osbuild.systemd
          options:
            enabled_services:
              - NetworkManager.service
              - firewalld.service
              - initial-setup.service
              - sshd.service
        - type: org.osbuild.selinux
          options:
            file_contexts: etc/selinux/targeted/contexts/files/file_contexts
      # cannot include "pipeline/images.yaml" this one odes not use grub2-inst
    - name: image
      build: name:build
      stages:
        otk.op.join:
          values:
            - otk.external.otk-make-partition-stages:
                ${filesystem}
            - - type: org.osbuild.copy
                inputs:
                  root-tree:
                    type: org.osbuild.tree
                    origin: org.osbuild.pipeline
                    references:
                      - name:os
                options:
                  paths:
                    - from: input://root-tree/
                      to: mount://-/
                mounts:
                  ${fs_options.mounts}
                devices:
                  ${fs_options.devices}
    - name: xz
      build: name:build
      stages:
        - type: org.osbuild.xz
          inputs:
            file:
              type: org.osbuild.files
              origin: org.osbuild.pipeline
              references:
                name:image:
                  file: disk.img
          options:
            filename: disk.raw.xz
  sources:
    org.osbuild.curl:
