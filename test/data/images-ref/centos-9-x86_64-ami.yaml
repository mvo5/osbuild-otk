# generated via the image repo
#
# $ go build ./cmd/build/ && OSBUILD_TESTING_RNG_SEED=0 ./cmd/build/build -config config.json -distro centos-9 -type qcow2
# $ $GOPATH/bin/yq -P < centos_9-x86_64-ami-/manifest.json > centos_9-x86_64-ami-/manifest.yaml
# mange UUIDs as the generate code creates different ones from images (but
# still predictable)
#
# and stripping out the "inputs" and "curl" pieces
version: "2"
pipelines:
  - name: build
    runner: org.osbuild.centos9
    stages:
      - type: org.osbuild.rpm
      - type: org.osbuild.fix-bls
        options:
          prefix: ""
      - type: org.osbuild.locale
        options:
          language: en_US.UTF-8
      - type: org.osbuild.keymap
        options:
          keymap: us
          x11-keymap:
            layouts:
              - us
      - type: org.osbuild.timezone
        options:
          zone: UTC
      - type: org.osbuild.chrony
        options:
          servers:
            - hostname: 169.254.169.123
              minpoll: 4
              maxpoll: 4
              iburst: true
              prefer: true
          leapsectz: ""
      - type: org.osbuild.sysconfig
        options:
          kernel:
            update_default: true
            default_kernel: kernel
          network:
            networking: true
            no_zero_conf: true
          network-scripts:
            ifcfg:
              eth0:
                bootproto: dhcp
                device: eth0
                ipv6init: false
                onboot: true
                peerdns: true
                type: Ethernet
                userctl: true
      - type: org.osbuild.systemd-logind
        options:
          filename: 00-getty-fixes.conf
          config:
            Login:
              NAutoVTs: 0
      - type: org.osbuild.cloud-init
        options:
          filename: 00-rhel-default-user.cfg
          config:
            system_info:
              default_user:
                name: ec2-user
      - type: org.osbuild.modprobe
        options:
          filename: blacklist-nouveau.conf
          commands:
            - command: blacklist
              modulename: nouveau
      - type: org.osbuild.modprobe
        options:
          filename: blacklist-amdgpu.conf
          commands:
            - command: blacklist
              modulename: amdgpu
      - type: org.osbuild.dracut.conf
        options:
          filename: sgdisk.conf
          config:
            install_items:
              - sgdisk
      - type: org.osbuild.dracut.conf
        options:
          filename: ec2.conf
          config:
            add_drivers:
              - nvme
              - xen-blkfront
      - type: org.osbuild.systemd.unit
        options:
          unit: nm-cloud-setup.service
          dropin: 10-rh-enable-for-ec2.conf
          config:
            Service:
              Environment:
                - key: NM_CLOUD_SETUP_EC2
                  value: "yes"
      - type: org.osbuild.authselect
        options:
          profile: sssd
      - type: org.osbuild.sshd.config
        options:
          config:
            PasswordAuthentication: false
      - type: org.osbuild.fstab
        options:
          filesystems:
            - uuid: 9851898e-0b30-437d-8fad-51ec16c3697f
              vfs_type: xfs
              path: /
              options: defaults
            - uuid: dbd21911-1c4e-4107-8a9f-14fe6e751358
              vfs_type: xfs
              path: /boot
              options: defaults
            - uuid: 7B77-95E7
              vfs_type: vfat
              path: /boot/efi
              options: defaults,uid=0,gid=0,umask=077,shortname=winnt
              passno: 2
      - type: org.osbuild.grub2
        options:
          root_fs_uuid: 9851898e-0b30-437d-8fad-51ec16c3697f
          boot_fs_uuid: dbd21911-1c4e-4107-8a9f-14fe6e751358
          kernel_opts: console=tty0 console=ttyS0,115200n8 net.ifnames=0 nvme_core.io_timeout=4294967295
          legacy: i386-pc
          uefi:
            vendor: centos
            unified: true
          saved_entry: ffffffffffffffffffffffffffffffff-5.14.0-503.el9.x86_64
          write_cmdline: false
          config:
            default: saved
      - type: org.osbuild.systemd
        options:
          enabled_services:
            - sshd
            - NetworkManager
            - nm-cloud-setup.service
            - nm-cloud-setup.timer
            - cloud-init
            - cloud-init-local
            - cloud-config
            - cloud-final
            - reboot.target
            - tuned
          default_target: multi-user.target
      - type: org.osbuild.selinux
        options:
          file_contexts: etc/selinux/targeted/contexts/files/file_contexts
  - name: image
    build: name:build
    stages:
      - type: org.osbuild.truncate
        options:
          filename: image.raw
          size: "10737418240"
      - type: org.osbuild.sfdisk
        options:
          label: gpt
          uuid: D209C89E-EA5E-4FBD-B161-B461CCE297E0
          partitions:
            - bootable: true
              size: 2048
              start: 2048
              type: 21686148-6449-6E6F-744E-656564454649
              uuid: FAC7F1FB-3E8D-4137-A512-961DE09A5549
            - size: 409600
              start: 4096
              type: C12A7328-F81F-11D2-BA4B-00A0C93EC93B
              uuid: 68B2905B-DF3E-4FB3-80FA-49D1E773AA33
            - size: 2097152
              start: 413696
              type: BC13C2FF-59E6-4262-A352-B275FD6F7172
              uuid: CB07C243-BC44-4717-853E-28852021225B
            - size: 18460639
              start: 2510848
              type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
              uuid: 6264D520-3FB9-423F-8AB8-7A0A8E3D3562
        devices:
          device:
            type: org.osbuild.loopback
            options:
              filename: image.raw
              lock: true
      - type: org.osbuild.mkfs.fat
        options:
          volid: 7B7795E7
        devices:
          device:
            type: org.osbuild.loopback
            options:
              filename: image.raw
              start: 4096
              size: 409600
              lock: true
      - type: org.osbuild.mkfs.xfs
        options:
          uuid: dbd21911-1c4e-4107-8a9f-14fe6e751358
          label: boot
        devices:
          device:
            type: org.osbuild.loopback
            options:
              filename: image.raw
              start: 413696
              size: 2097152
              lock: true
      - type: org.osbuild.mkfs.xfs
        options:
          uuid: 9851898e-0b30-437d-8fad-51ec16c3697f
          label: root
        devices:
          device:
            type: org.osbuild.loopback
            options:
              filename: image.raw
              start: 2510848
              size: 18460639
              lock: true
      - type: org.osbuild.copy
        inputs:
          root-tree:
            type: org.osbuild.tree
            origin: org.osbuild.pipeline
            references:
              - name:os
        options:
          paths:
            - from: input://root-tree/
              to: mount://-/
        devices:
          '-':
            type: org.osbuild.loopback
            options:
              filename: image.raw
              start: 2510848
              size: 18460639
          boot:
            type: org.osbuild.loopback
            options:
              filename: image.raw
              start: 413696
              size: 2097152
          boot-efi:
            type: org.osbuild.loopback
            options:
              filename: image.raw
              start: 4096
              size: 409600
        mounts:
          - name: '-'
            type: org.osbuild.xfs
            source: '-'
            target: /
          - name: boot
            type: org.osbuild.xfs
            source: boot
            target: /boot
          - name: boot-efi
            type: org.osbuild.fat
            source: boot-efi
            target: /boot/efi
      - type: org.osbuild.grub2.inst
        options:
          filename: image.raw
          platform: i386-pc
          location: 2048
          core:
            type: mkimage
            partlabel: gpt
            filesystem: xfs
          prefix:
            type: partition
            partlabel: gpt
            number: 2
            path: /grub2
sources:
  org.osbuild.curl:
