otk.version: "1"

otk.define:
  filesystem:
    otk.external.otk-gen-partition-table:
      modifications:
        filename: "image.raw"
      properties:
        create:
          bios_boot_partition: true
          esp_partition: true
          esp_partition_size: "200 MiB"
        type: gpt
        bios: true
        default_size: "10 GiB"
        uuid: D209C89E-EA5E-4FBD-B161-B461CCE297E0
      partitions:
        - name: boot
          mountpoint: /boot
          label: boot
          size: "1 GiB"
          type: "xfs"
          # XXX: make default if empty
          fs_mntops: defaults
          # XXX can we derive this?
          part_type: BC13C2FF-59E6-4262-A352-B275FD6F7172
          # XXX: yes we use hardcoded uuids
          part_uuid: CB07C243-BC44-4717-853E-28852021225B
        - name: root
          mountpoint: /
          label: root
          type: "xfs"
          # XXX: can/should we be able to leave this empy?
          size: "5 GiB"
          # XXX: make default if empty
          fs_mntops: defaults
          # XXX: can we derive this?
          part_type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
          # XXX: yes we use hardcoded uuids
          part_uuid: 6264D520-3FB9-423F-8AB8-7A0A8E3D3562
  # XXX: find a better way
  fs_options:
    otk.external.otk-make-partition-mounts-devices:
      ${filesystem}

otk.target.osbuild:
  pipelines:
    - name: build
      runner: org.osbuild.centos9
      stages:
        - type: org.osbuild.rpm
        - type: org.osbuild.fix-bls
          options:
            prefix: ""
        - type: org.osbuild.locale
          options:
            language: en_US.UTF-8
        - type: org.osbuild.keymap
          options:
            keymap: us
            x11-keymap:
              layouts:
                - us
        - type: org.osbuild.timezone
          options:
            zone: UTC
        - type: org.osbuild.chrony
          options:
            servers:
              - hostname: 169.254.169.123
                minpoll: 4
                maxpoll: 4
                iburst: true
                prefer: true
            leapsectz: ""
        - type: org.osbuild.sysconfig
          options:
            kernel:
              update_default: true
              default_kernel: kernel
            network:
              networking: true
              no_zero_conf: true
            network-scripts:
              ifcfg:
                eth0:
                  bootproto: dhcp
                  device: eth0
                  ipv6init: false
                  onboot: true
                  peerdns: true
                  type: Ethernet
                  userctl: true
        - type: org.osbuild.systemd-logind
          options:
            filename: 00-getty-fixes.conf
            config:
              Login:
                NAutoVTs: 0
        - type: org.osbuild.cloud-init
          options:
            filename: 00-rhel-default-user.cfg
            config:
              system_info:
                default_user:
                  name: ec2-user
        - type: org.osbuild.modprobe
          options:
            filename: blacklist-nouveau.conf
            commands:
              - command: blacklist
                modulename: nouveau
        - type: org.osbuild.modprobe
          options:
            filename: blacklist-amdgpu.conf
            commands:
              - command: blacklist
                modulename: amdgpu
        - type: org.osbuild.dracut.conf
          options:
            filename: sgdisk.conf
            config:
              install_items:
                - sgdisk
        - type: org.osbuild.dracut.conf
          options:
            filename: ec2.conf
            config:
              add_drivers:
                - nvme
                - xen-blkfront
        - type: org.osbuild.systemd.unit
          options:
            unit: nm-cloud-setup.service
            dropin: 10-rh-enable-for-ec2.conf
            config:
              Service:
                Environment:
                  - key: NM_CLOUD_SETUP_EC2
                    value: "yes"
        - type: org.osbuild.authselect
          options:
            profile: sssd
        - type: org.osbuild.sshd.config
          options:
            config:
              PasswordAuthentication: false
        - otk.external.otk-make-fstab-stage:
            ${filesystem}
        - type: org.osbuild.grub2
          options:
            root_fs_uuid: ${filesystem.const.partition_map.root.uuid}
            boot_fs_uuid: ${filesystem.const.partition_map.boot.uuid}
            kernel_opts: console=tty0 console=ttyS0,115200n8 net.ifnames=0 nvme_core.io_timeout=4294967295
            legacy: i386-pc
            uefi:
              vendor: centos
              unified: true
            saved_entry: ffffffffffffffffffffffffffffffff-5.14.0-503.el9.x86_64
            write_cmdline: false
            config:
              default: saved
        - type: org.osbuild.systemd
          options:
            enabled_services:
              - sshd
              - NetworkManager
              - nm-cloud-setup.service
              - nm-cloud-setup.timer
              - cloud-init
              - cloud-init-local
              - cloud-config
              - cloud-final
              - reboot.target
              - tuned
            default_target: multi-user.target
        - type: org.osbuild.selinux
          options:
            file_contexts: etc/selinux/targeted/contexts/files/file_contexts
    - name: image
      build: name:build
      stages:
        otk.op.join:
          values:
            - otk.external.otk-make-partition-stages:
                ${filesystem}
            - - type: org.osbuild.copy
                inputs:
                  root-tree:
                    type: org.osbuild.tree
                    origin: org.osbuild.pipeline
                    references:
                      - name:os
                options:
                  paths:
                    - from: input://root-tree/
                      to: mount://-/
                # XXX: fugly, can we do better?
                # we cannot just do
                #   otk.external.otk-make-partition-mounts-devices:
                # here because "otk.external." does not allow siblings
                mounts:
                  ${fs_options.mounts}
                devices:
                  ${fs_options.devices}
              - type: org.osbuild.grub2.inst
                options:
                  filename: ${filesystem.const.filename}
                  platform: i386-pc
                  location: 2048
                  core:
                    type: mkimage
                    partlabel: gpt
                    filesystem: xfs
                  prefix:
                    type: partition
                    partlabel: gpt
                    number: 2
                    path: /grub2
  sources:
    org.osbuild.curl:
